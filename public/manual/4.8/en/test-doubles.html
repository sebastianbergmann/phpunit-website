<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <title>PHPUnit Manual &#8211; Chapter 9. Test Doubles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="canonical" href="https://phpunit.de/manual/current/en/test-doubles.html">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/highlight.css" rel="stylesheet">
  <link href="css/style.css" rel="stylesheet">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700%7CSource+Code+Pro:400,700' rel='stylesheet' type='text/css'>
  <!--[if lt IE 9]><script src="js/html5shiv.min.js"></script><![endif]-->
 </head>
 <body>
  <nav class="navbar navbar-default" role="navigation">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav navbar-left">
            <li>
                <a href="https://phpunit.de/documentation.html">This documentation is outdated. Please follow this link to learn about the new documentation.</a>
            </li>
        </ul>
    </div>
  </nav>
  <div class="container-fluid">
   <div class="row">
    <div class="col-md-4 col-lg-3">
     <div class="well well-sm sidebar-nav">
<dl class="toc nav hidden-print"><dt><span class="chapter"><a href="installation.html">1. Installing PHPUnit</a></span></dt><dd><dl><dt><span class="section"><a href="installation.html#installation.requirements">Requirements</a></span></dt><dt><span class="section"><a href="installation.html#installation.phar">PHP Archive (PHAR)</a></span></dt><dd><dl><dt><span class="section"><a href="installation.html#installation.phar.windows">Windows</a></span></dt><dt><span class="section"><a href="installation.html#installation.phar.verification">Verifying PHPUnit PHAR Releases</a></span></dt></dl></dd><dt><span class="section"><a href="installation.html#installation.composer">Composer</a></span></dt><dt><span class="section"><a href="installation.html#installation.optional-packages">Optional packages</a></span></dt></dl></dd><dt><span class="chapter"><a href="writing-tests-for-phpunit.html">2. Writing Tests for PHPUnit</a></span></dt><dd><dl><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.test-dependencies">Test Dependencies</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.data-providers">Data Providers</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.exceptions">Testing Exceptions</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.errors">Testing PHP Errors</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.output">Testing Output</a></span></dt><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.error-output">Error output</a></span></dt><dd><dl><dt><span class="section"><a href="writing-tests-for-phpunit.html#writing-tests-for-phpunit.error-output.edge-cases">Edge cases</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="textui.html">3. The Command-Line Test Runner</a></span></dt><dd><dl><dt><span class="section"><a href="textui.html#textui.clioptions">Command-Line Options</a></span></dt></dl></dd><dt><span class="chapter"><a href="fixtures.html">4. Fixtures</a></span></dt><dd><dl><dt><span class="section"><a href="fixtures.html#fixtures.more-setup-than-teardown">More setUp() than tearDown()</a></span></dt><dt><span class="section"><a href="fixtures.html#fixtures.variations">Variations</a></span></dt><dt><span class="section"><a href="fixtures.html#fixtures.sharing-fixture">Sharing Fixture</a></span></dt><dt><span class="section"><a href="fixtures.html#fixtures.global-state">Global State</a></span></dt></dl></dd><dt><span class="chapter"><a href="organizing-tests.html">5. Organizing Tests</a></span></dt><dd><dl><dt><span class="section"><a href="organizing-tests.html#organizing-tests.filesystem">Composing a Test Suite Using the Filesystem</a></span></dt><dt><span class="section"><a href="organizing-tests.html#organizing-tests.xml-configuration">Composing a Test Suite Using XML Configuration</a></span></dt></dl></dd><dt><span class="chapter"><a href="risky-tests.html">6. Risky Tests</a></span></dt><dd><dl><dt><span class="section"><a href="risky-tests.html#risky-tests.useless-tests">Useless Tests</a></span></dt><dt><span class="section"><a href="risky-tests.html#risky-tests.unintentionally-covered-code">Unintentionally Covered Code</a></span></dt><dt><span class="section"><a href="risky-tests.html#risky-tests.output-during-test-execution">Output During Test Execution</a></span></dt><dt><span class="section"><a href="risky-tests.html#risky-tests.test-execution-timeout">Test Execution Timeout</a></span></dt><dt><span class="section"><a href="risky-tests.html#risky-tests.global-state-manipulation">Global State Manipulation</a></span></dt></dl></dd><dt><span class="chapter"><a href="incomplete-and-skipped-tests.html">7. Incomplete and Skipped Tests</a></span></dt><dd><dl><dt><span class="section"><a href="incomplete-and-skipped-tests.html#incomplete-and-skipped-tests.incomplete-tests">Incomplete Tests</a></span></dt><dt><span class="section"><a href="incomplete-and-skipped-tests.html#incomplete-and-skipped-tests.skipping-tests">Skipping Tests</a></span></dt><dt><span class="section"><a href="incomplete-and-skipped-tests.html#incomplete-and-skipped-tests.skipping-tests-using-requires">Skipping Tests using @requires</a></span></dt></dl></dd><dt><span class="chapter"><a href="database.html">8. Database Testing</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.supported-vendors-for-database-testing">Supported Vendors for Database Testing</a></span></dt><dt><span class="section"><a href="database.html#database.difficulties-in-database-testing">Difficulties in Database Testing</a></span></dt><dt><span class="section"><a href="database.html#database.the-four-stages-of-a-database-test">The four stages of a database test</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.clean-up-database">1. Clean-Up Database</a></span></dt><dt><span class="section"><a href="database.html#database.set-up-fixture">2. Set up fixture</a></span></dt><dt><span class="section"><a href="database.html#database.run-test-verify-outcome-and-teardown">3–5. Run Test, Verify outcome and Teardown</a></span></dt></dl></dd><dt><span class="section"><a href="database.html#database.configuration-of-a-phpunit-database-testcase">Configuration of a PHPUnit Database TestCase</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.implementing-getconnection">Implementing getConnection()</a></span></dt><dt><span class="section"><a href="database.html#database.implementing-getdataset">Implementing getDataSet()</a></span></dt><dt><span class="section"><a href="database.html#database.what-about-the-database-schema-ddl">What about the Database Schema (DDL)?</a></span></dt><dt><span class="section"><a href="database.html#database.tip-use-your-own-abstract-database-testcase">Tip: Use your own Abstract Database TestCase</a></span></dt></dl></dd><dt><span class="section"><a href="database.html#database.understanding-datasets-and-datatables">Understanding DataSets and DataTables</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.available-implementations">Available Implementations</a></span></dt><dt><span class="section"><a href="database.html#database.beware-of-foreign-keys">Beware of Foreign Keys</a></span></dt><dt><span class="section"><a href="database.html#database.implementing-your-own-datasetsdatatables">Implementing your own DataSets/DataTables</a></span></dt></dl></dd><dt><span class="section"><a href="database.html#database.the-connection-api">The Connection API</a></span></dt><dt><span class="section"><a href="database.html#database.database-assertions-api">Database Assertions API</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.asserting-the-row-count-of-a-table">Asserting the Row-Count of a Table</a></span></dt><dt><span class="section"><a href="database.html#database.asserting-the-state-of-a-table">Asserting the State of a Table</a></span></dt><dt><span class="section"><a href="database.html#database.asserting-the-result-of-a-query">Asserting the Result of a Query</a></span></dt><dt><span class="section"><a href="database.html#database.asserting-the-state-of-multiple-tables">Asserting the State of Multiple Tables</a></span></dt></dl></dd><dt><span class="section"><a href="database.html#database.frequently-asked-questions">Frequently Asked Questions</a></span></dt><dd><dl><dt><span class="section"><a href="database.html#database.will-phpunit-re-create-the-database-schema-for-each-test">Will PHPUnit (re-)create the database schema for each
             test?</a></span></dt><dt><span class="section"><a href="database.html#database.am-i-required-to-use-pdo-in-my-application-for-the-database-extension-to-work">Am I required to use PDO in my application for the Database
             Extension to work?</a></span></dt><dt><span class="section"><a href="database.html#database.what-can-i-do-when-i-get-a-too-much-connections-error">What can I do, when I get a
             <span class="quote">“<span class="quote">Too much Connections</span>”</span> Error?</a></span></dt><dt><span class="section"><a href="database.html#database.how-to-handle-null-with-flat-xml-csv-datasets">How to handle NULL with Flat XML / CSV Datasets?</a></span></dt></dl></dd></dl></dd><dt><span class="chapter"><a href="test-doubles.html" class="active">9. Test Doubles</a></span></dt><dd><dl><dt><span class="section"><a href="test-doubles.html#test-doubles.stubs">Stubs</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.mock-objects">Mock Objects</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.prophecy">Prophecy</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.mocking-traits-and-abstract-classes">Mocking Traits and Abstract Classes</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.stubbing-and-mocking-web-services">Stubbing and Mocking Web Services</a></span></dt><dt><span class="section"><a href="test-doubles.html#test-doubles.mocking-the-filesystem">Mocking the Filesystem</a></span></dt></dl></dd><dt><span class="chapter"><a href="testing-practices.html">10. Testing Practices</a></span></dt><dd><dl><dt><span class="section"><a href="testing-practices.html#testing-practices.during-development">During Development</a></span></dt><dt><span class="section"><a href="testing-practices.html#testing-practices.during-debugging">During Debugging</a></span></dt></dl></dd><dt><span class="chapter"><a href="code-coverage-analysis.html">11. Code Coverage Analysis</a></span></dt><dd><dl><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.metrics">Software Metrics for Code Coverage</a></span></dt><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.including-excluding-files">Including and Excluding Files</a></span></dt><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.ignoring-code-blocks">Ignoring Code Blocks</a></span></dt><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.specifying-covered-methods">Specifying Covered Methods</a></span></dt><dt><span class="section"><a href="code-coverage-analysis.html#code-coverage-analysis.edge-cases">Edge Cases</a></span></dt></dl></dd><dt><span class="chapter"><a href="other-uses-for-tests.html">12. Other Uses for Tests</a></span></dt><dd><dl><dt><span class="section"><a href="other-uses-for-tests.html#other-uses-for-tests.agile-documentation">Agile Documentation</a></span></dt><dt><span class="section"><a href="other-uses-for-tests.html#other-uses-for-tests.cross-team-tests">Cross-Team Tests</a></span></dt></dl></dd><dt><span class="chapter"><a href="selenium.html">13. PHPUnit and Selenium</a></span></dt><dd><dl><dt><span class="section"><a href="selenium.html#selenium.selenium-rc">Selenium Server</a></span></dt><dt><span class="section"><a href="selenium.html#selenium.installation">Installation</a></span></dt><dt><span class="section"><a href="selenium.html#selenium.selenium2testcase">PHPUnit_Extensions_Selenium2TestCase</a></span></dt><dt><span class="section"><a href="selenium.html#selenium.seleniumtestcase">PHPUnit_Extensions_SeleniumTestCase</a></span></dt></dl></dd><dt><span class="chapter"><a href="logging.html">14. Logging</a></span></dt><dd><dl><dt><span class="section"><a href="logging.html#logging.xml">Test Results (XML)</a></span></dt><dt><span class="section"><a href="logging.html#logging.tap">Test Results (TAP)</a></span></dt><dt><span class="section"><a href="logging.html#logging.json">Test Results (JSON)</a></span></dt><dt><span class="section"><a href="logging.html#logging.codecoverage.xml">Code Coverage (XML)</a></span></dt><dt><span class="section"><a href="logging.html#logging.codecoverage.text">Code Coverage (TEXT)</a></span></dt></dl></dd><dt><span class="chapter"><a href="extending-phpunit.html">15. Extending PHPUnit</a></span></dt><dd><dl><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.PHPUnit_Framework_TestCase">Subclass PHPUnit_Framework_TestCase</a></span></dt><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.custom-assertions">Write custom assertions</a></span></dt><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.PHPUnit_Framework_TestListener">Implement PHPUnit_Framework_TestListener</a></span></dt><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.PHPUnit_Extensions_TestDecorator">Subclass PHPUnit_Extensions_TestDecorator</a></span></dt><dt><span class="section"><a href="extending-phpunit.html#extending-phpunit.PHPUnit_Framework_Test">Implement PHPUnit_Framework_Test</a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.assertions.html">A. Assertions</a></span></dt><dd><dl><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertArrayHasKey">assertArrayHasKey()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertClassHasAttribute">assertClassHasAttribute()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertArraySubset">assertArraySubset()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertClassHasStaticAttribute">assertClassHasStaticAttribute()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertContains">assertContains()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertContainsOnly">assertContainsOnly()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertContainsOnlyInstancesOf">assertContainsOnlyInstancesOf()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertCount">assertCount()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertEmpty">assertEmpty()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertEqualXMLStructure">assertEqualXMLStructure()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertEquals">assertEquals()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertFalse">assertFalse()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertFileEquals">assertFileEquals()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertFileExists">assertFileExists()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertGreaterThan">assertGreaterThan()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertGreaterThanOrEqual">assertGreaterThanOrEqual()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertInstanceOf">assertInstanceOf()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertInternalType">assertInternalType()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertJsonFileEqualsJsonFile">assertJsonFileEqualsJsonFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertJsonStringEqualsJsonFile">assertJsonStringEqualsJsonFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertJsonStringEqualsJsonString">assertJsonStringEqualsJsonString()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertLessThan">assertLessThan()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertLessThanOrEqual">assertLessThanOrEqual()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertNull">assertNull()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertObjectHasAttribute">assertObjectHasAttribute()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertRegExp">assertRegExp()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringMatchesFormat">assertStringMatchesFormat()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringMatchesFormatFile">assertStringMatchesFormatFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertSame">assertSame()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringEndsWith">assertStringEndsWith()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringEqualsFile">assertStringEqualsFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertStringStartsWith">assertStringStartsWith()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertThat">assertThat()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertTrue">assertTrue()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertXmlFileEqualsXmlFile">assertXmlFileEqualsXmlFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertXmlStringEqualsXmlFile">assertXmlStringEqualsXmlFile()</a></span></dt><dt><span class="section"><a href="appendixes.assertions.html#appendixes.assertions.assertXmlStringEqualsXmlString">assertXmlStringEqualsXmlString()</a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.annotations.html">B. Annotations</a></span></dt><dd><dl><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.author">@author</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.after">@after</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.afterClass">@afterClass</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.backupGlobals">@backupGlobals</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.backupStaticAttributes">@backupStaticAttributes</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.before">@before</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.beforeClass">@beforeClass</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.codeCoverageIgnore">@codeCoverageIgnore*</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.covers">@covers</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.coversDefaultClass">@coversDefaultClass</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.coversNothing">@coversNothing</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.dataProvider">@dataProvider</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.depends">@depends</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.expectedException">@expectedException</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.expectedExceptionCode">@expectedExceptionCode</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.expectedExceptionMessage">@expectedExceptionMessage</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.expectedExceptionMessageRegExp">@expectedExceptionMessageRegExp</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.group">@group</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.large">@large</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.medium">@medium</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.preserveGlobalState">@preserveGlobalState</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.requires">@requires</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.runTestsInSeparateProcesses">@runTestsInSeparateProcesses</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.runInSeparateProcess">@runInSeparateProcess</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.small">@small</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.test">@test</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.testdox">@testdox</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.testWith">@testWith</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.ticket">@ticket</a></span></dt><dt><span class="section"><a href="appendixes.annotations.html#appendixes.annotations.uses">@uses</a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.configuration.html">C. The XML Configuration File</a></span></dt><dd><dl><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.phpunit">PHPUnit</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.testsuites">Test Suites</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.groups">Groups</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.blacklist-whitelist">Including and Excluding Files for Code Coverage</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.logging">Logging</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.test-listeners">Test Listeners</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.php-ini-constants-variables">Setting PHP INI settings, Constants and Global Variables</a></span></dt><dt><span class="section"><a href="appendixes.configuration.html#appendixes.configuration.selenium-rc">Configuring Browsers for Selenium RC</a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.upgrading.html">D. Upgrading</a></span></dt><dd><dl><dt><span class="section"><a href="appendixes.upgrading.html#appendixes.upgrading.phpunit-4-0">Upgrading from PHPUnit 3.7 to PHPUnit 4.0</a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.index.html">E. Index</a></span></dt><dd><dl><dt><span class="index"><a href="appendixes.index.html#appendixes.index.index"></a></span></dt></dl></dd><dt><span class="appendix"><a href="appendixes.bibliography.html">F. Bibliography</a></span></dt><dt><span class="appendix"><a href="appendixes.copyright.html">G. Copyright</a></span></dt></dl>
     </div>
    </div>
    <div class="col-md-8 col-lg-9">
     <div class="row">
      <div class="col-md-1 pull-left prev-nav"><a accesskey="p" href="database.html">Prev</a></div>
      <div class="col-md-1 pull-right next-nav"><a accesskey="n" href="testing-practices.html">Next</a></div>
     </div>
<div class="chapter"><div class="titlepage"><div><div><h1 class="title"><a id="test-doubles"></a>Chapter 9. Test Doubles</h1></div></div></div><p>
    Gerard Meszaros introduces the concept of Test Doubles in
    <a class="xref" href="appendixes.bibliography.html#Meszaros2007" title="xUnit Test Patterns: Refactoring Test Code">[<abbr class="abbrev">Meszaros2007</abbr>]</a> like this:
  </p><div class="blockquote"><table border="0" class="blockquote" style="width: 100%; cellspacing: 0; cellpadding: 0;" summary="Block quote"><tr><td width="10%" valign="top"> </td><td width="80%" valign="top"><p>
      <a id="idm139877745596928" class="indexterm"></a>

      Sometimes it is just plain hard to test the system under test (SUT)
      because it depends on other components that cannot be used in the test
      environment. This could be because they aren't available, they will not
      return the results needed for the test or because executing them would
      have undesirable side effects. In other cases, our test strategy requires
      us to have more control or visibility of the internal behavior of the SUT.
    </p><p>
      <a id="idm139877745595440" class="indexterm"></a>
      <a id="idm139877745594864" class="indexterm"></a>

      When we are writing a test in which we cannot (or chose not to) use a real
      depended-on component (DOC), we can replace it with a Test Double. The
      Test Double doesn't have to behave exactly like the real DOC; it merely
      has to provide the same API as the real one so that the SUT thinks it is
      the real one!
    </p></td><td width="10%" valign="top"> </td></tr><tr><td width="10%" valign="top"> </td><td colspan="2" align="right" valign="top">--<span class="attribution">Gerard Meszaros</span></td></tr></table></div><p>
    The <code class="literal">getMockBuilder($type)</code> method provided by PHPUnit can
    be used in a test to automatically generate an object that can act as a test
    double for the specified original type (interface or class name). This test
    double object can be used in every context where an object of the original
    type is expected or required.
  </p><p>
    By default, all methods of the original class are replaced with a dummy
    implementation that just returns <code class="literal">null</code> (without calling
    the original method). Using the <code class="literal">will($this-&gt;returnValue())</code>
    method, for instance, you can configure these dummy implementations to
    return a value when called.
  </p><div class="alert alert-info"><h3 class="title">Limitation: final, private, and static methods</h3><p>
      Please note that <code class="literal">final</code>, <code class="literal">private</code>
      and <code class="literal">static</code> methods cannot be stubbed or mocked. They
      are ignored by PHPUnit's test double functionality and retain their
      original behavior.
    </p></div><div class="alert alert-danger"><h3 class="title">Warning</h3><p>
        Please pay attention to the fact that the parameters managing has been changed.
        The previous implementation clones all object parameters. It did not allow to check whether the same object was passed to method or not.
        <a class="xref" href="test-doubles.html#test-doubles.mock-objects.examples.clone-object-parameters-usecase.php" title="Example 9.15: Testing that a method gets called once and with the identical object as was passed">Example 9.15</a> shows where the new implementation could be useful.
        <a class="xref" href="test-doubles.html#test-doubles.mock-objects.examples.enable-clone-object-parameters.php" title="Example 9.16: Create a mock object with cloning parameters enabled">Example 9.16</a> shows how to switch back to previous behavior.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.stubs"></a>Stubs</h2></div></div></div><p>
      <a id="idm139877745584304" class="indexterm"></a>

      The practice of replacing an object with a test double that (optionally)
      returns configured return values is referred to as
      <span class="emphasis"><em>stubbing</em></span>. You can use a <span class="emphasis"><em>stub</em></span> to
      "replace a real component on which the SUT depends so that the test has a
      control point for the indirect inputs of the SUT. This allows the test to
      force the SUT down paths it might not otherwise execute".
    </p><p>
      <a id="idm139877745582032" class="indexterm"></a>

      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest.php" title="Example 9.2: Stubbing a method call to return a fixed value">Example 9.2</a> shows how
      to stub method calls and set up return values. We first use the
      <code class="literal">getMockBuilder()</code> method that is provided by the
      <code class="literal">PHPUnit_Framework_TestCase</code> class to set up a stub
      object that looks like an object of <code class="literal">SomeClass</code>
      (<a class="xref" href="test-doubles.html#test-doubles.stubs.examples.SomeClass.php" title="Example 9.1: The class we want to stub">Example 9.1</a>). We then
      use the <a class="ulink" href="http://martinfowler.com/bliki/FluentInterface.html" target="_top">Fluent Interface</a>
      that PHPUnit provides to specify the behavior for the stub. In essence,
      this means that you do not need to create several temporary objects and
      wire them together afterwards. Instead, you chain method calls as shown in
      the example. This leads to more readable and "fluent" code.
    </p><div class="example"><a id="test-doubles.stubs.examples.SomeClass.php"></a><p class="title"><strong>Example 9.1: The class we want to stub</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class SomeClass
{
    public function doSomething()
    {
        // Do something.
    }
}
?&gt;</pre></div></div><br class="example-break"></br><div class="example"><a id="test-doubles.stubs.examples.StubTest.php"></a><p class="title"><strong>Example 9.2: Stubbing a method call to return a fixed value</strong></p><div class="example-contents"><a id="idm139877745456288" class="indexterm"></a><a id="idm139877745455712" class="indexterm"></a><a id="idm139877745455136" class="indexterm"></a><pre class="programlisting">&lt;?php
require_once 'SomeClass.php';

class StubTest extends PHPUnit_Framework_TestCase
{
    public function testStub()
    {
        // Create a stub for the SomeClass class.
        $stub = $this-&gt;getMockBuilder('SomeClass')
                     -&gt;getMock();

        // Configure the stub.
        $stub-&gt;method('doSomething')
             -&gt;willReturn('foo');

        // Calling $stub-&gt;doSomething() will now return
        // 'foo'.
        $this-&gt;assertEquals('foo', $stub-&gt;doSomething());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><div class="alert alert-info"><h3 class="title">Limitation: Methods named "method"</h3><p>
        The example shown above only works when the original class does not
        declare a method named "method".
      </p><p>
        If the original class does declare a method named "method" then <code class="literal">$stub-&gt;expects($this-&gt;any())-&gt;method('doSomething')-&gt;willReturn('foo');</code> has to be used.
      </p></div><p>
      "Behind the scenes", PHPUnit automatically generates a new PHP class that
      implements the desired behavior when the <code class="literal">getMock()</code>
      method is used.
    </p><p>
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest2.php" title="Example 9.3: Using the Mock Builder API can be used to configure the generated test double class">Example 9.3</a> shows an
      example of how to use the Mock Builder's fluent interface to configure the
      creation of the test double.
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest2.php"></a><p class="title"><strong>Example 9.3: Using the Mock Builder API can be used to configure the generated test double class</strong></p><div class="example-contents"><a id="idm139877745447824" class="indexterm"></a><a id="idm139877745447248" class="indexterm"></a><a id="idm139877745446672" class="indexterm"></a><pre class="programlisting">&lt;?php
require_once 'SomeClass.php';

class StubTest extends PHPUnit_Framework_TestCase
{
    public function testStub()
    {
        // Create a stub for the SomeClass class.
        $stub = $this-&gt;getMockBuilder('SomeClass')
                     -&gt;disableOriginalConstructor()
                     -&gt;getMock();

        // Configure the stub.
        $stub-&gt;method('doSomething')
             -&gt;willReturn('foo');

        // Calling $stub-&gt;doSomething() will now return
        // 'foo'.
        $this-&gt;assertEquals('foo', $stub-&gt;doSomething());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      Here is a list of methods provided by the Mock Builder:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p><code class="literal">setMethods(array $methods)</code> can be called on the Mock Builder object to specify the methods that are to be replaced with a configurable test double. The behavior of the other methods is not changed. If you call <code class="literal">setMethods(null)</code>, then no methods will be replaced.</p></li><li class="listitem"><p><code class="literal">setConstructorArgs(array $args)</code> can be called to provide a parameter array that is passed to the original class' constructor (which is not replaced with a dummy implementation by default).</p></li><li class="listitem"><p><code class="literal">setMockClassName($name)</code> can be used to specify a class name for the generated test double class.</p></li><li class="listitem"><p><code class="literal">disableOriginalConstructor()</code> can be used to disable the call to the original class' constructor.</p></li><li class="listitem"><p><code class="literal">disableOriginalClone()</code> can be used to disable the call to the original class' clone constructor.</p></li><li class="listitem"><p><code class="literal">disableAutoload()</code> can be used to disable <code class="literal">__autoload()</code> during the generation of the test double class.</p></li></ul></div><p>
      In the examples so far we have been returning simple values using
      <code class="literal">willReturn($value)</code>. This short syntax is the same as
      <code class="literal">will($this-&gt;returnValue($value))</code>. We can use variations
      on this longer syntax to achieve more complex stubbing behaviour.
    </p><p>
      Sometimes you want to return one of the arguments of a method call
      (unchanged) as the result of a stubbed method call.
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest3.php" title="Example 9.4: Stubbing a method call to return one of the arguments">Example 9.4</a> shows how you
      can achieve this using <code class="literal">returnArgument()</code> instead of
      <code class="literal">returnValue()</code>.
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest3.php"></a><p class="title"><strong>Example 9.4: Stubbing a method call to return one of the arguments</strong></p><div class="example-contents"><a id="idm139877745432672" class="indexterm"></a><a id="idm139877745432096" class="indexterm"></a><a id="idm139877745431520" class="indexterm"></a><a id="idm139877745430944" class="indexterm"></a><pre class="programlisting">&lt;?php
require_once 'SomeClass.php';

class StubTest extends PHPUnit_Framework_TestCase
{
    public function testReturnArgumentStub()
    {
        // Create a stub for the SomeClass class.
        $stub = $this-&gt;getMockBuilder('SomeClass')
                     -&gt;getMock();

        // Configure the stub.
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;returnArgument(0));

        // $stub-&gt;doSomething('foo') returns 'foo'
        $this-&gt;assertEquals('foo', $stub-&gt;doSomething('foo'));

        // $stub-&gt;doSomething('bar') returns 'bar'
        $this-&gt;assertEquals('bar', $stub-&gt;doSomething('bar'));
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      When testing a fluent interface, it is sometimes useful to have a stubbed
      method return a reference to the stubbed object.
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest4.php" title="Example 9.5: Stubbing a method call to return a reference to the stub object">Example 9.5</a> shows how you
      can use <code class="literal">returnSelf()</code> to achieve this.
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest4.php"></a><p class="title"><strong>Example 9.5: Stubbing a method call to return a reference to the stub object</strong></p><div class="example-contents"><a id="idm139877745195536" class="indexterm"></a><a id="idm139877745194960" class="indexterm"></a><a id="idm139877745194384" class="indexterm"></a><a id="idm139877745193808" class="indexterm"></a><pre class="programlisting">&lt;?php
require_once 'SomeClass.php';

class StubTest extends PHPUnit_Framework_TestCase
{
    public function testReturnSelf()
    {
        // Create a stub for the SomeClass class.
        $stub = $this-&gt;getMockBuilder('SomeClass')
                     -&gt;getMock();

        // Configure the stub.
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;returnSelf());

        // $stub-&gt;doSomething() returns $stub
        $this-&gt;assertSame($stub, $stub-&gt;doSomething());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      Sometimes a stubbed method should return different values depending on
      a predefined list of arguments.  You can use
      <code class="literal">returnValueMap()</code> to create a map that associates
      arguments with corresponding return values. See
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest5.php" title="Example 9.6: Stubbing a method call to return the value from a map">Example 9.6</a> for
      an example.
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest5.php"></a><p class="title"><strong>Example 9.6: Stubbing a method call to return the value from a map</strong></p><div class="example-contents"><a id="idm139877745189360" class="indexterm"></a><a id="idm139877745188784" class="indexterm"></a><a id="idm139877745188208" class="indexterm"></a><a id="idm139877745187632" class="indexterm"></a><pre class="programlisting">&lt;?php
require_once 'SomeClass.php';

class StubTest extends PHPUnit_Framework_TestCase
{
    public function testReturnValueMapStub()
    {
        // Create a stub for the SomeClass class.
        $stub = $this-&gt;getMockBuilder('SomeClass')
                     -&gt;getMock();

        // Create a map of arguments to return values.
        $map = array(
          array('a', 'b', 'c', 'd'),
          array('e', 'f', 'g', 'h')
        );

        // Configure the stub.
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;returnValueMap($map));

        // $stub-&gt;doSomething() returns different values depending on
        // the provided arguments.
        $this-&gt;assertEquals('d', $stub-&gt;doSomething('a', 'b', 'c'));
        $this-&gt;assertEquals('h', $stub-&gt;doSomething('e', 'f', 'g'));
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      When the stubbed method call should return a calculated value instead of
      a fixed one (see <code class="literal">returnValue()</code>) or an (unchanged)
      argument (see <code class="literal">returnArgument()</code>), you can use
      <code class="literal">returnCallback()</code> to have the stubbed method return the
      result of a callback function or method. See
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest6.php" title="Example 9.7: Stubbing a method call to return a value from a callback">Example 9.7</a> for an example.
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest6.php"></a><p class="title"><strong>Example 9.7: Stubbing a method call to return a value from a callback</strong></p><div class="example-contents"><a id="idm139877745182000" class="indexterm"></a><a id="idm139877745181424" class="indexterm"></a><a id="idm139877745180848" class="indexterm"></a><a id="idm139877745180272" class="indexterm"></a><pre class="programlisting">&lt;?php
require_once 'SomeClass.php';

class StubTest extends PHPUnit_Framework_TestCase
{
    public function testReturnCallbackStub()
    {
        // Create a stub for the SomeClass class.
        $stub = $this-&gt;getMockBuilder('SomeClass')
                     -&gt;getMock();

        // Configure the stub.
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;returnCallback('str_rot13'));

        // $stub-&gt;doSomething($argument) returns str_rot13($argument)
        $this-&gt;assertEquals('fbzrguvat', $stub-&gt;doSomething('something'));
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      A simpler alternative to setting up a callback method may be to
      specify a list of desired return values. You can do this with
      the <code class="literal">onConsecutiveCalls()</code> method. See
      <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest7.php" title="Example 9.8: Stubbing a method call to return a list of values in the specified order">Example 9.8</a> for
      an example.
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest7.php"></a><p class="title"><strong>Example 9.8: Stubbing a method call to return a list of values in the
      specified order</strong></p><div class="example-contents"><a id="idm139877745175824" class="indexterm"></a><a id="idm139877745175248" class="indexterm"></a><a id="idm139877745174672" class="indexterm"></a><a id="idm139877745174096" class="indexterm"></a><pre class="programlisting">&lt;?php
require_once 'SomeClass.php';

class StubTest extends PHPUnit_Framework_TestCase
{
    public function testOnConsecutiveCallsStub()
    {
        // Create a stub for the SomeClass class.
        $stub = $this-&gt;getMockBuilder('SomeClass')
                     -&gt;getMock();

        // Configure the stub.
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;onConsecutiveCalls(2, 3, 5, 7));

        // $stub-&gt;doSomething() returns a different value each time
        $this-&gt;assertEquals(2, $stub-&gt;doSomething());
        $this-&gt;assertEquals(3, $stub-&gt;doSomething());
        $this-&gt;assertEquals(5, $stub-&gt;doSomething());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      Instead of returning a value, a stubbed method can also raise an
      exception. <a class="xref" href="test-doubles.html#test-doubles.stubs.examples.StubTest8.php" title="Example 9.9: Stubbing a method call to throw an exception">Example 9.9</a>
      shows how to use <code class="literal">throwException()</code> to do this.
    </p><div class="example"><a id="test-doubles.stubs.examples.StubTest8.php"></a><p class="title"><strong>Example 9.9: Stubbing a method call to throw an exception</strong></p><div class="example-contents"><a id="idm139877745169584" class="indexterm"></a><a id="idm139877745169008" class="indexterm"></a><a id="idm139877745168432" class="indexterm"></a><a id="idm139877745167856" class="indexterm"></a><pre class="programlisting">&lt;?php
require_once 'SomeClass.php';

class StubTest extends PHPUnit_Framework_TestCase
{
    public function testThrowExceptionStub()
    {
        // Create a stub for the SomeClass class.
        $stub = $this-&gt;getMockBuilder('SomeClass')
                     -&gt;getMock();

        // Configure the stub.
        $stub-&gt;method('doSomething')
             -&gt;will($this-&gt;throwException(new Exception));

        // $stub-&gt;doSomething() throws Exception
        $stub-&gt;doSomething();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      Alternatively, you can write the stub yourself and improve your design
      along the way. Widely used resources are accessed through a single façade,
      so you can easily replace the resource with the stub. For example,
      instead of having direct database calls scattered throughout the code,
      you have a single <code class="literal">Database</code> object, an implementor of
      the <code class="literal">IDatabase</code> interface. Then, you can create a stub
      implementation of <code class="literal">IDatabase</code> and use it for your
      tests. You can even create an option for running the tests with the
      stub database or the real database, so you can use your tests for both
      local testing during development and integration testing with the real
      database.
    </p><p>
      Functionality that needs to be stubbed out tends to cluster in the same
      object, improving cohesion. By presenting the functionality with a
      single, coherent interface you reduce the coupling with the rest of the
      system.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.mock-objects"></a>Mock Objects</h2></div></div></div><p>
      The practice of replacing an object with a test double that verifies
      expectations, for instance asserting that a method has been called, is
      referred to as <span class="emphasis"><em>mocking</em></span>.
    </p><p>
      <a id="idm139877745160064" class="indexterm"></a>

      You can use a <span class="emphasis"><em>mock object</em></span> "as an observation point
      that is used to verify the indirect outputs of the SUT as it is exercised.
      Typically, the mock object also includes the functionality of a test stub
      in that it must return values to the SUT if it hasn't already failed the
      tests but the emphasis is on the verification of the indirect outputs.
      Therefore, a mock object is a lot more than just a test stub plus
      assertions; it is used in a fundamentally different way" (Gerard Meszaros).
    </p><div class="alert alert-info"><h3 class="title">Limitation: Automatic verification of expectations</h3><p>
        Only mock objects generated within the scope of a test will be verified
        automatically by PHPUnit. Mock objects generated in data providers, for
        instance, or injected into the test using the <code class="literal">@depends</code>
        annotation will not be verified automatically by PHPUnit.
      </p></div><p>
      Here is an example: suppose we want to test that the correct method,
      <code class="literal">update()</code> in our example, is called on an object that
      observes another object. <a class="xref" href="test-doubles.html#test-doubles.mock-objects.examples.SUT.php" title="Example 9.10: The Subject and Observer classes that are part of the System under Test (SUT)">Example 9.10</a>
      shows the code for the <code class="literal">Subject</code> and <code class="literal">Observer</code>
      classes that are part of the System under Test (SUT).
    </p><div class="example"><a id="test-doubles.mock-objects.examples.SUT.php"></a><p class="title"><strong>Example 9.10: The Subject and Observer classes that are part of the System under Test (SUT)</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class Subject
{
    protected $observers = array();
    protected $name;

    public function __construct($name)
    {
        $this-&gt;name = $name;
    }

    public function getName()
    {
        return $this-&gt;name;
    }

    public function attach(Observer $observer)
    {
        $this-&gt;observers[] = $observer;
    }

    public function doSomething()
    {
        // Do something.
        // ...

        // Notify observers that we did something.
        $this-&gt;notify('something');
    }

    public function doSomethingBad()
    {
        foreach ($this-&gt;observers as $observer) {
            $observer-&gt;reportError(42, 'Something bad happened', $this);
        }
    }

    protected function notify($argument)
    {
        foreach ($this-&gt;observers as $observer) {
            $observer-&gt;update($argument);
        }
    }

    // Other methods.
}

class Observer
{
    public function update($argument)
    {
        // Do something.
    }

    public function reportError($errorCode, $errorMessage, Subject $subject)
    {
        // Do something
    }

    // Other methods.
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <a id="idm139877745150656" class="indexterm"></a>

      <a class="xref" href="test-doubles.html#test-doubles.mock-objects.examples.SubjectTest.php" title="Example 9.11: Testing that a method gets called once and with a specified argument">Example 9.11</a>
      shows how to use a mock object to test the interaction between
      <code class="literal">Subject</code> and <code class="literal">Observer</code> objects.
    </p><p>
      We first use the <code class="literal">getMock()</code> method that is provided by
      the <code class="literal">PHPUnit_Framework_TestCase</code> class to set up a mock
      object for the <code class="literal">Observer</code>. Since we give an array as the
      second (optional) parameter for the <code class="literal">getMock()</code> method,
      only the <code class="literal">update()</code> method of the
      <code class="literal">Observer</code> class is replaced by a mock implementation.
    </p><p>
      Because we are interested in verifying that a method is called, and which
      arguments it is called with, we introduce the <code class="literal">expects()</code> and
      <code class="literal">with()</code> methods to specify how this interaction should look.
    </p><div class="example"><a id="test-doubles.mock-objects.examples.SubjectTest.php"></a><p class="title"><strong>Example 9.11: Testing that a method gets called once and with a specified argument</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class SubjectTest extends PHPUnit_Framework_TestCase
{
    public function testObserversAreUpdated()
    {
        // Create a mock for the Observer class,
        // only mock the update() method.
        $observer = $this-&gt;getMockBuilder('Observer')
                         -&gt;setMethods(array('update'))
                         -&gt;getMock();

        // Set up the expectation for the update() method
        // to be called only once and with the string 'something'
        // as its parameter.
        $observer-&gt;expects($this-&gt;once())
                 -&gt;method('update')
                 -&gt;with($this-&gt;equalTo('something'));

        // Create a Subject object and attach the mocked
        // Observer object to it.
        $subject = new Subject('My subject');
        $subject-&gt;attach($observer);

        // Call the doSomething() method on the $subject object
        // which we expect to call the mocked Observer object's
        // update() method with the string 'something'.
        $subject-&gt;doSomething();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      The <code class="literal">with()</code> method can take any number of
      arguments, corresponding to the number of arguments to the
      method being mocked. You can specify more advanced constraints
      on the method's arguments than a simple match.
    </p><div class="example"><a id="test-doubles.mock-objects.examples.SubjectTest2.php"></a><p class="title"><strong>Example 9.12: Testing that a method gets called with a number of
      arguments constrained in different ways</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class SubjectTest extends PHPUnit_Framework_TestCase
{
    public function testErrorReported()
    {
        // Create a mock for the Observer class, mocking the
        // reportError() method
        $observer = $this-&gt;getMockBuilder('Observer')
                         -&gt;setMethods(array('reportError'))
                         -&gt;getMock();

        $observer-&gt;expects($this-&gt;once())
                 -&gt;method('reportError')
                 -&gt;with(
                       $this-&gt;greaterThan(0),
                       $this-&gt;stringContains('Something'),
                       $this-&gt;anything()
                   );

        $subject = new Subject('My subject');
        $subject-&gt;attach($observer);

        // The doSomethingBad() method should report an error to the observer
        // via the reportError() method
        $subject-&gt;doSomethingBad();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      The <code class="literal">withConsecutive()</code> method can take any number of
      arrays of arguments, depending on the calls you want to test against.
      Each array is a list of constraints corresponding to the arguments of the
      method being mocked, like in <code class="literal">with()</code>.
    </p><div class="example"><a id="test-doubles.mock-objects.examples.with-consecutive.php"></a><p class="title"><strong>Example 9.13: Testing that a method gets called two times with specific arguments.</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class FooTest extends PHPUnit_Framework_TestCase
{
    public function testFunctionCalledTwoTimesWithSpecificArguments()
    {
        $mock = $this-&gt;getMockBuilder('stdClass')
                     -&gt;setMethods(array('set'))
                     -&gt;getMock();

        $mock-&gt;expects($this-&gt;exactly(2))
             -&gt;method('set')
             -&gt;withConsecutive(
                 array($this-&gt;equalTo('foo'), $this-&gt;greaterThan(0)),
                 array($this-&gt;equalTo('bar'), $this-&gt;greaterThan(0))
             );

        $mock-&gt;set('foo', 21);
        $mock-&gt;set('bar', 48);
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      The <code class="literal">callback()</code> constraint can be used for more complex
      argument verification. This constraint takes a PHP callback as its only
      argument. The PHP callback will receive the argument to be verified as
      its only argument and should return <code class="literal">TRUE</code> if the
      argument passes verification and <code class="literal">FALSE</code> otherwise.
    </p><div class="example"><a id="test-doubles.mock-objects.examples.SubjectTest3.php"></a><p class="title"><strong>Example 9.14: More complex argument verification</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class SubjectTest extends PHPUnit_Framework_TestCase
{
    public function testErrorReported()
    {
        // Create a mock for the Observer class, mocking the
        // reportError() method
        $observer = $this-&gt;getMockBuilder('Observer')
                         -&gt;setMethods(array('reportError'))
                         -&gt;getMock();

        $observer-&gt;expects($this-&gt;once())
                 -&gt;method('reportError')
                 -&gt;with($this-&gt;greaterThan(0),
                        $this-&gt;stringContains('Something'),
                        $this-&gt;callback(function($subject){
                          return is_callable(array($subject, 'getName')) &amp;&amp;
                                 $subject-&gt;getName() == 'My subject';
                        }));

        $subject = new Subject('My subject');
        $subject-&gt;attach($observer);

        // The doSomethingBad() method should report an error to the observer
        // via the reportError() method
        $subject-&gt;doSomethingBad();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><div class="example"><a id="test-doubles.mock-objects.examples.clone-object-parameters-usecase.php"></a><p class="title"><strong>Example 9.15: Testing that a method gets called once and with the identical object as was passed</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class FooTest extends PHPUnit_Framework_TestCase
{
    public function testIdenticalObjectPassed()
    {
        $expectedObject = new stdClass;

        $mock = $this-&gt;getMockBuilder('stdClass')
                     -&gt;setMethods(array('foo'))
                     -&gt;getMock();

        $mock-&gt;expects($this-&gt;once())
             -&gt;method('foo')
             -&gt;with($this-&gt;identicalTo($expectedObject));

        $mock-&gt;foo($expectedObject);
    }
}
?&gt;</pre></div></div><br class="example-break"></br><div class="example"><a id="test-doubles.mock-objects.examples.enable-clone-object-parameters.php"></a><p class="title"><strong>Example 9.16: Create a mock object with cloning parameters enabled</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class FooTest extends PHPUnit_Framework_TestCase
{
    public function testIdenticalObjectPassed()
    {
        $cloneArguments = true;

        $mock = $this-&gt;getMockBuilder('stdClass')
                     -&gt;enableArgumentCloning()
                     -&gt;getMock();

        // now your mock clones parameters so the identicalTo constraint
        // will fail.
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <a class="xref" href="appendixes.assertions.html#appendixes.assertions.assertThat.tables.constraints" title="Table A.1. Constraints">Table A.1</a>
      shows the constraints that can be applied to method arguments and
      <a class="xref" href="test-doubles.html#test-doubles.mock-objects.tables.matchers" title="Table 9.1. Matchers">Table 9.1</a>
      shows the matchers that are available to specify the number of
      invocations.
    </p><div class="table"><a id="test-doubles.mock-objects.tables.matchers"></a><p class="title"><strong>Table 9.1. Matchers</strong></p><div class="table-contents"><table class="table" summary="Matchers" border="1"><colgroup><col></col><col></col></colgroup><thead><tr><th align="left">Matcher</th><th align="left">Meaning</th></tr></thead><tbody><tr><td align="left"><code class="literal">PHPUnit_Framework_MockObject_Matcher_AnyInvokedCount any()</code></td><td align="left">Returns a matcher that matches when the method it is evaluated for is executed zero or more times.</td></tr><tr><td align="left"><code class="literal">PHPUnit_Framework_MockObject_Matcher_InvokedCount never()</code></td><td align="left">Returns a matcher that matches when the method it is evaluated for is never executed.</td></tr><tr><td align="left"><code class="literal">PHPUnit_Framework_MockObject_Matcher_InvokedAtLeastOnce atLeastOnce()</code></td><td align="left">Returns a matcher that matches when the method it is evaluated for is executed at least once.</td></tr><tr><td align="left"><code class="literal">PHPUnit_Framework_MockObject_Matcher_InvokedCount once()</code></td><td align="left">Returns a matcher that matches when the method it is evaluated for is executed exactly once.</td></tr><tr><td align="left"><code class="literal">PHPUnit_Framework_MockObject_Matcher_InvokedCount exactly(int $count)</code></td><td align="left">Returns a matcher that matches when the method it is evaluated for is executed exactly <code class="literal">$count</code> times.</td></tr><tr><td align="left"><code class="literal">PHPUnit_Framework_MockObject_Matcher_InvokedAtIndex at(int $index)</code></td><td align="left">Returns a matcher that matches when the method it is evaluated for is invoked at the given <code class="literal">$index</code>.</td></tr></tbody></table></div></div><br class="table-break"></br><div class="alert alert-info"><h3 class="title">Note</h3><p>
        The <code class="literal">$index</code> parameter for the <code class="literal">at()</code>
        matcher refers to the index, starting at zero, in <span class="emphasis"><em>all method
        invocations</em></span> for a given mock object. Exercise caution when
        using this matcher as it can lead to brittle tests which are too
        closely tied to specific implementation details.
      </p></div></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.prophecy"></a>Prophecy</h2></div></div></div><p>
      <a class="ulink" href="https://github.com/phpspec/prophecy" target="_top">Prophecy</a> is a
      "highly opinionated yet very powerful and flexible PHP object mocking
      framework. Though initially it was created to fulfil phpspec2 needs, it is
      flexible enough to be used inside any testing framework out there with
      minimal effort".
    </p><p>
      PHPUnit has built-in support for using Prophecy to create test doubles
      since version 4.5. <a class="xref" href="test-doubles.html#test-doubles.prophecy.examples.SubjectTest.php" title="Example 9.17: Testing that a method gets called once and with a specified argument">Example 9.17</a>
      shows how the same test shown in <a class="xref" href="test-doubles.html#test-doubles.mock-objects.examples.SubjectTest.php" title="Example 9.11: Testing that a method gets called once and with a specified argument">Example 9.11</a>
      can be expressed using Prophecy's philosophy of prophecies and
      revelations:
    </p><div class="example"><a id="test-doubles.prophecy.examples.SubjectTest.php"></a><p class="title"><strong>Example 9.17: Testing that a method gets called once and with a specified argument</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class SubjectTest extends PHPUnit_Framework_TestCase
{
    public function testObserversAreUpdated()
    {
        $subject = new Subject('My subject');

        // Create a prophecy for the Observer class.
        $observer = $this-&gt;prophesize('Observer');

        // Set up the expectation for the update() method
        // to be called only once and with the string 'something'
        // as its parameter.
        $observer-&gt;update('something')-&gt;shouldBeCalled();

        // Reveal the prophecy and attach the mock object
        // to the Subject.
        $subject-&gt;attach($observer-&gt;reveal());

        // Call the doSomething() method on the $subject object
        // which we expect to call the mocked Observer object's
        // update() method with the string 'something'.
        $subject-&gt;doSomething();
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      Please refer to the <a class="ulink" href="https://github.com/phpspec/prophecy#how-to-use-it" target="_top">documentation</a>
      for Prophecy for further details on how to create, configure, and use
      stubs, spies, and mocks using this alternative test double framework.
    </p></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.mocking-traits-and-abstract-classes"></a>Mocking Traits and Abstract Classes</h2></div></div></div><p>
      <a id="idm139877745094832" class="indexterm"></a>

      The <code class="literal">getMockForTrait()</code> method returns a mock object
      that uses a specified trait. All abstract methods of the given trait
      are mocked. This allows for testing the concrete methods of a trait.
    </p><div class="example"><a id="test-doubles.mock-objects.examples.TraitClassTest.php"></a><p class="title"><strong>Example 9.18: Testing the concrete methods of a trait</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
trait AbstractTrait
{
    public function concreteMethod()
    {
        return $this-&gt;abstractMethod();
    }

    public abstract function abstractMethod();
}

class TraitClassTest extends PHPUnit_Framework_TestCase
{
    public function testConcreteMethod()
    {
        $mock = $this-&gt;getMockForTrait('AbstractTrait');

        $mock-&gt;expects($this-&gt;any())
             -&gt;method('abstractMethod')
             -&gt;will($this-&gt;returnValue(TRUE));

        $this-&gt;assertTrue($mock-&gt;concreteMethod());
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      <a id="idm139877745091024" class="indexterm"></a>

      The <code class="literal">getMockForAbstractClass()</code> method returns a mock
      object for an abstract class. All abstract methods of the given abstract
      class are mocked. This allows for testing the concrete methods of an
      abstract class.
    </p><div class="example"><a id="test-doubles.mock-objects.examples.AbstractClassTest.php"></a><p class="title"><strong>Example 9.19: Testing the concrete methods of an abstract class</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
abstract class AbstractClass
{
    public function concreteMethod()
    {
        return $this-&gt;abstractMethod();
    }

    public abstract function abstractMethod();
}

class AbstractClassTest extends PHPUnit_Framework_TestCase
{
    public function testConcreteMethod()
    {
        $stub = $this-&gt;getMockForAbstractClass('AbstractClass');

        $stub-&gt;expects($this-&gt;any())
             -&gt;method('abstractMethod')
             -&gt;will($this-&gt;returnValue(TRUE));

        $this-&gt;assertTrue($stub-&gt;concreteMethod());
    }
}
?&gt;</pre></div></div><br class="example-break"></br></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.stubbing-and-mocking-web-services"></a>Stubbing and Mocking Web Services</h2></div></div></div><p>
      <a id="idm139877745085888" class="indexterm"></a>

      When your application interacts with a web service you want to test it
      without actually interacting with the web service. To make the stubbing
      and mocking of web services easy, the <code class="literal">getMockFromWsdl()</code>
      can be used just like <code class="literal">getMock()</code> (see above). The only
      difference is that <code class="literal">getMockFromWsdl()</code> returns a stub or
      mock based on a web service description in WSDL and <code class="literal">getMock()</code>
      returns a stub or mock based on a PHP class or interface.
    </p><p>
      <a class="xref" href="test-doubles.html#test-doubles.stubbing-and-mocking-web-services.examples.GoogleTest.php" title="Example 9.20: Stubbing a web service">Example 9.20</a>
      shows how <code class="literal">getMockFromWsdl()</code> can be used to stub, for
      example, the web service described in <code class="filename">GoogleSearch.wsdl</code>.
    </p><div class="example"><a id="test-doubles.stubbing-and-mocking-web-services.examples.GoogleTest.php"></a><p class="title"><strong>Example 9.20: Stubbing a web service</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class GoogleTest extends PHPUnit_Framework_TestCase
{
    public function testSearch()
    {
        $googleSearch = $this-&gt;getMockFromWsdl(
          'GoogleSearch.wsdl', 'GoogleSearch'
        );

        $directoryCategory = new stdClass;
        $directoryCategory-&gt;fullViewableName = '';
        $directoryCategory-&gt;specialEncoding = '';

        $element = new stdClass;
        $element-&gt;summary = '';
        $element-&gt;URL = 'https://phpunit.de/';
        $element-&gt;snippet = '...';
        $element-&gt;title = '&lt;b&gt;PHPUnit&lt;/b&gt;';
        $element-&gt;cachedSize = '11k';
        $element-&gt;relatedInformationPresent = TRUE;
        $element-&gt;hostName = 'phpunit.de';
        $element-&gt;directoryCategory = $directoryCategory;
        $element-&gt;directoryTitle = '';

        $result = new stdClass;
        $result-&gt;documentFiltering = FALSE;
        $result-&gt;searchComments = '';
        $result-&gt;estimatedTotalResultsCount = 3.9000;
        $result-&gt;estimateIsExact = FALSE;
        $result-&gt;resultElements = array($element);
        $result-&gt;searchQuery = 'PHPUnit';
        $result-&gt;startIndex = 1;
        $result-&gt;endIndex = 1;
        $result-&gt;searchTips = '';
        $result-&gt;directoryCategories = array();
        $result-&gt;searchTime = 0.248822;

        $googleSearch-&gt;expects($this-&gt;any())
                     -&gt;method('doGoogleSearch')
                     -&gt;will($this-&gt;returnValue($result));

        /**
         * $googleSearch-&gt;doGoogleSearch() will now return a stubbed result and
         * the web service's doGoogleSearch() method will not be invoked.
         */
        $this-&gt;assertEquals(
          $result,
          $googleSearch-&gt;doGoogleSearch(
            '00000000000000000000000000000000',
            'PHPUnit',
            0,
            1,
            FALSE,
            '',
            FALSE,
            '',
            '',
            ''
          )
        );
    }
}
?&gt;</pre></div></div><br class="example-break"></br></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="test-doubles.mocking-the-filesystem"></a>Mocking the Filesystem</h2></div></div></div><p>
      <a class="ulink" href="https://github.com/mikey179/vfsStream" target="_top">vfsStream</a>
      is a <a class="ulink" href="http://www.php.net/streams" target="_top">stream wrapper</a> for a
      <a class="ulink" href="http://en.wikipedia.org/wiki/Virtual_file_system" target="_top">virtual
      filesystem</a> that may be helpful in unit tests to mock the real
      filesystem.
    </p><p>
      Simply add a dependency on <code class="literal">mikey179/vfsStream</code> to your
      project's <code class="literal">composer.json</code> file if you use
      <a class="ulink" href="https://getcomposer.org/" target="_top">Composer</a> to manage the
      dependencies of your project. Here is a minimal example of a
      <code class="literal">composer.json</code> file that just defines a development-time
      dependency on PHPUnit 4.6 and vfsStream:
    </p><pre class="programlisting">{
    "require-dev": {
        "phpunit/phpunit": "~4.6",
        "mikey179/vfsStream": "~1"
    }
}</pre><p>
      <a class="xref" href="test-doubles.html#test-doubles.mocking-the-filesystem.examples.Example.php" title="Example 9.21: A class that interacts with the filesystem">Example 9.21</a>
      shows a class that interacts with the filesystem.
    </p><div class="example"><a id="test-doubles.mocking-the-filesystem.examples.Example.php"></a><p class="title"><strong>Example 9.21: A class that interacts with the filesystem</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
class Example
{
    protected $id;
    protected $directory;

    public function __construct($id)
    {
        $this-&gt;id = $id;
    }

    public function setDirectory($directory)
    {
        $this-&gt;directory = $directory . DIRECTORY_SEPARATOR . $this-&gt;id;

        if (!file_exists($this-&gt;directory)) {
            mkdir($this-&gt;directory, 0700, TRUE);
        }
    }
}?&gt;</pre></div></div><br class="example-break"></br><p>
      Without a virtual filesystem such as vfsStream we cannot test the
      <code class="literal">setDirectory()</code> method in isolation from external
      influence (see <a class="xref" href="test-doubles.html#test-doubles.mocking-the-filesystem.examples.ExampleTest.php" title="Example 9.22: Testing a class that interacts with the filesystem">Example 9.22</a>).
    </p><div class="example"><a id="test-doubles.mocking-the-filesystem.examples.ExampleTest.php"></a><p class="title"><strong>Example 9.22: Testing a class that interacts with the filesystem</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
require_once 'Example.php';

class ExampleTest extends PHPUnit_Framework_TestCase
{
    protected function setUp()
    {
        if (file_exists(dirname(__FILE__) . '/id')) {
            rmdir(dirname(__FILE__) . '/id');
        }
    }

    public function testDirectoryIsCreated()
    {
        $example = new Example('id');
        $this-&gt;assertFalse(file_exists(dirname(__FILE__) . '/id'));

        $example-&gt;setDirectory(dirname(__FILE__));
        $this-&gt;assertTrue(file_exists(dirname(__FILE__) . '/id'));
    }

    protected function tearDown()
    {
        if (file_exists(dirname(__FILE__) . '/id')) {
            rmdir(dirname(__FILE__) . '/id');
        }
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      The approach above has several drawbacks:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>As with any external resource, there might be intermittent problems with the filesystem. This makes tests interacting with it flaky.</p></li><li class="listitem"><p>In the <code class="literal">setUp()</code> and <code class="literal">tearDown()</code> methods we have to ensure that the directory does not exist before and after the test.</p></li><li class="listitem"><p>When the test execution terminates before the <code class="literal">tearDown()</code> method is invoked the directory will stay in the filesystem.</p></li></ul></div><p>
      <a class="xref" href="test-doubles.html#test-doubles.mocking-the-filesystem.examples.ExampleTest2.php" title="Example 9.23: Mocking the filesystem in a test for a class that interacts with the filesystem">Example 9.23</a>
      shows how vfsStream can be used to mock the filesystem in a test for a
      class that interacts with the filesystem.
    </p><div class="example"><a id="test-doubles.mocking-the-filesystem.examples.ExampleTest2.php"></a><p class="title"><strong>Example 9.23: Mocking the filesystem in a test for a class that interacts with the filesystem</strong></p><div class="example-contents"><pre class="programlisting">&lt;?php
require_once 'vfsStream/vfsStream.php';
require_once 'Example.php';

class ExampleTest extends PHPUnit_Framework_TestCase
{
    public function setUp()
    {
        vfsStreamWrapper::register();
        vfsStreamWrapper::setRoot(new vfsStreamDirectory('exampleDir'));
    }

    public function testDirectoryIsCreated()
    {
        $example = new Example('id');
        $this-&gt;assertFalse(vfsStreamWrapper::getRoot()-&gt;hasChild('id'));

        $example-&gt;setDirectory(vfsStream::url('exampleDir'));
        $this-&gt;assertTrue(vfsStreamWrapper::getRoot()-&gt;hasChild('id'));
    }
}
?&gt;</pre></div></div><br class="example-break"></br><p>
      This has several advantages:
    </p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The test itself is more concise.</p></li><li class="listitem"><p>vfsStream gives the test developer full control over what the filesystem environment looks like to the tested code.</p></li><li class="listitem"><p>Since the filesystem operations do not operate on the real filesystem anymore, cleanup operations in a <code class="literal">tearDown()</code> method are no longer required.</p></li></ul></div></div></div>
     <div class="row">
      <div class="col-md-1 pull-left prev-nav"><a accesskey="p" href="database.html">Prev</a></div>
      <div class="col-md-1 pull-right next-nav"><a accesskey="n" href="testing-practices.html">Next</a></div>
     </div>
    </div>
   </div>
   <hr/>
   <footer>
    <p><a href="appendixes.copyright.html">Copyright</a> &copy; 2005-2017 <a href="http://sebastian-bergmann.de/">Sebastian Bergmann</a>.</p>
   </footer>
  </div>
  <script src="js/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/highlight.pack.js"></script>
  <script type="text/javascript">
  $(document).ready(function() { $('pre.programlisting').each(function(i, e) {hljs.highlightBlock(e)}); });
  </script>
 </body>
</html>
